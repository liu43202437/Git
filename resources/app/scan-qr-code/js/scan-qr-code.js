"use strict";$(function(s){var a,e,t=(a=new RegExp("(^|&)"+"sid"+"=([^&]*)(&|$)"),null!=(e=s.location.search.substr(1).match(a))?unescape(e[2]):null),n=$(".js-load-box"),o=$(".load-text");function d(a){var e=a.appid,t=a.ticket,n=parseInt((new Date).valueOf()/1e3),o=function(s){for(var a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",e=[],t=0;t<s;t++){var n=a.substr(parseInt(Math.random()*a.length),1);e.push(n)}return e.join("")}(16),d="jsapi_ticket="+t+"&noncestr="+o+"&timestamp="+n+"&url="+s.location.href.split("#")[0],i=$.sha1(d);wx.config({debug:!1,appId:e,timestamp:n,nonceStr:o,signature:i,jsApiList:["scanQRCode"]})}n&&(n.addClass("loading"),$(".load-box").removeClass("loaded"),o.text("正在加载...")),apiByObj({service:"getTicket",path:"/mobile/Js_interface/"}).then(function(s){s&&d(s=JSON.parse(s))}).catch(function(s){n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"})}),wx.error(function(s){if(s){JSON.stringify(s);"config:invalid signature"===s.errMsg&&apiByObj({service:"getNewTicket",path:"/mobile/Js_interface/"}).then(function(s){s&&d(s=JSON.parse(s))}).catch(function(s){n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"})}),"config:invalid url domain"===s.errMsg&&(n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"}))}}),wx.ready(function(){n&&(n.removeClass("loading"),$(".load-box").addClass("loaded")),$(".redeem-prize").click(function(){wx.scanQRCode({desc:"scanQRCode desc",needResult:1,scanType:["qrCode","barCode","PDF417"],success:function(s){var a={code:s.resultStr.split(",")[1],sid:t};$(".load-box").removeClass("loaded"),$(".js-load-box").addClass("loading"),$(".load-text").text("正在查询..."),apiByObj({service:"doRedeem",path:"/mobile/Redeem/",data:a}).then(function(s){!function(s){var a=s.data?JSON.parse(s.data):null,e=a?a.content:null,n=s.msg,o="";a&&"1301"==a.ret?e&&e.prize&&(o+='<div class="py-10 f-20">兑奖成功，奖金 '+e.prize+"元</div>"):a&&a.msg&&(o+='<div class="py-10 f-20">'+a.msg+"</div>");e&&e.gameName&&(o+='<div class=\'pt-10 text-left\'><span class="s-l">兑换票种：</span><span class="s-r">'+e.gameName+"</span></div>");if(e&&e.transacId){var d=e.transacId.substr(0,14);i=d,l=(i=String(i)).substring(0,4),r=i.substring(4,6),c=i.substring(6,8),u=i.substring(8,10),p=i.substring(10,12),g=i.substring(12,14),o+='<div class=\'pt-10 text-left\'><span class="s-l">扫码时间：</span><span class="s-r">'+(d=l+"-"+r+"-"+c+" "+u+":"+p+":"+g)+"</span></div>"}var i,l,r,c,u,p,g;e&&e.ticketNo&&(o+=' <div class=\'pt-10 text-left\'><span class="s-l">兑奖单号：</span><span class="s-r">'+e.ticketNo+"</sapn></div>");var v="<div>"+o+"</div>";o&&($(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading"),a&&"1301"==a.ret?swal({content:$(v).get(0),type:"info",buttons:["关闭","确定"]}).then(function(s){s&&Router.navigate("/resources/app/scan-qr-code/redeem-record.html",{sid:t})}):swal({content:$(v).get(0),type:"info",button:"关闭"}));if(n){var f='<div class="py-10 f-20">'+n+"</div>";$(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading"),swal({content:$(f).get(0),type:"error",button:"关闭"})}}(s=JSON.parse(s))}).catch(function(s){$(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading");s=JSON.stringify(s);swal({button:"关闭",text:"网络连接错误，请重试"})})},error:function(s){s.errMsg.indexOf("function_not_exist")>0&&swal({button:"关闭",text:"版本过低请升级"})}})})}),$(".redeem-record").click(function(){Router.navigate("/resources/app/scan-qr-code/redeem-record.html",{sid:t})})}(window));