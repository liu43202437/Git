"use strict";$(function(t){var e=document.documentElement.clientHeight;$(".body-box").height(e-215),$(".list.lottery_list .list-body").height(e-215-52),$(t).resize(function(){e=document.documentElement.clientHeight,$(".body-box").height(e-215),$(".list.lottery_list .list-body").height(e-215-52)});var n,i,a=(n=new RegExp("(^|&)"+"sid"+"=([^&]*)(&|$)"),null!=(i=t.location.search.substr(1).match(n))?unescape(i[2]):null),s=3e3,o={0:{price:"0",title:"热销",icon:"iconfont icon-sell-hot-o"},2:{price:"2",title:"二元票",icon:"iconfont icon-two-o1"},5:{price:"5",title:"五元票",icon:"iconfont icon-five-o1"},10:{price:"10",title:"十元票",icon:"iconfont icon-ten-o1"},20:{price:"20",title:"二十元票",icon:"iconfont icon-icon-test"}};apiByObj({path:"/mobile/Ticket/",service:"getTicketType",data:{sid:a}}).then(function(e){var n=JSON.parse(e),i=n.data.type,d=[];if(0===n.code||Array.isArray(i)){s=Number(n.data.total),i.unshift("0");var r=!0,l=!1,c=void 0;try{for(var v,u=i[Symbol.iterator]();!(r=(v=u.next()).done);r=!0){var m=v.value;o[m]&&d.push(o[m])}}catch(t){l=!0,c=t}finally{try{!r&&u.return&&u.return()}finally{if(l)throw c}}var p=$(".lottery_list>.list-body");$(".lottery_item:first");$(".lottery_money").data("money",0);var b=$(".lottery_money").data("money");!function(t,e){for(var n=0;n<t.length;n++){var i=t[n],a='<div class="nav-item"><i class="'+i.icon+' f-40" aria-hidden="true"></i></div>';e.append(a),$(".nav-item:last").data("nav_data",i)}}(d,$(".nav>.nav-box")),$(".nav-item:first").addClass("nav-active");var f=$(".nav-item.nav-active").data("nav_data").price,y=parseInt(new Date("2018-02-08").valueOf()/1e3),h=parseInt(new Date("2018-02-21").valueOf()/1e3),_=parseInt((new Date).valueOf()/1e3);_>y&&_<h&&swal({button:"确定",content:$('\n    <div>\n      <div class="pt-10 text-left">亲爱的各位零售店主：</div>\n      <div class="pt-10 text-left">\n        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 春节即将来临，物流配送不好安排，2月8日12时-2月21日24时，不做物流配送，在此期间所下订单统一在2月22号配送。 </p>\n      </div>\n      <div class="pt-10 text-left">\n        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 预祝大家新春快乐，阖家欢乐！</p>\n      </div>\n    </div>\n  ').get(0)}),$(".nav-box .nav-item").click(function(t){var e=$(t.target);e.is(".iconfont")&&(e=e.parent(".nav-item"));var n=e.data("nav_data");f!==n.price&&(f=n.price,$(".nav-item.nav-active").removeClass("nav-active"),e.addClass("nav-active"),$(".list>.list-title").text(n.title),w({price:f}))});var x={};w({price:"0"}),$(".lottery_list").click(function(t){var e,n=$(t.target);if(n.is(".plus_btn")||n.is(".minus_btn")){var i=n.parents(".lottery_item").data("item_data"),a=n.parents(".item-number").find(".minus"),o=n.parents(".item-number").find(".loterry_number"),d=n.parents(".item-number").find(".inventory");n.is(".plus_btn")&&((e=x[i.id]).num+1>i.inventory?swal({text:e.name+"当前库存不足了",button:"关闭"}).then(function(){console.log("swal")}).catch(swal.noop):Number(b)+Number(i.price)>s?swal({button:"关闭",text:"订单超过"+s+"元, 请选择其他商品,使订单刚好"+s+"元"}).catch(swal.noop):(e.num++,b+=Number(i.price),o.text(e.num))),n.is(".minus_btn")&&(x[i.id].num=x[i.id].num-1,o.text(x[i.id].num),b-=Number(i.price)),x[i.id].num>0?(o.removeClass("hidden"),a.removeClass("hidden"),d.removeClass("opacity")):(o.addClass("hidden"),a.addClass("hidden"),d.addClass("opacity")),b!==s?$(".go_buy").prop("disabled",!0):$(".go_buy").prop("disabled",!1),$(".lottery_money").text("￥"+b)}}),$(".go_buy").click(function(e){var n=[];$.each(x,function(t,e){0!==e.num&&n.push({id:t,num:e.num,name:e.name})});for(var i='<div><div>您已选择以下商品, 请确认下单</div><hr class="my">',s=0;s<n.length;s++)i+='<div class="row f-14 text-gray-45 text-left">\n        <div class="col-xs-6 col-xs-offset-2">\n          '+n[s].name+'\n        </div>\n        <div class="col-xs-4">\n          x'+n[s].num+"\n        </div>\n      </div>";i+="</div>",swal({content:$(i).get(0),type:"info",buttons:["取消","确定"]}).then(function(e){var i;e&&(i=n,i=JSON.stringify(i),api("apply_welfare_ticket",{data:i,sid:a}).then(function(e){1===(e=JSON.parse(e)).status.succeed&&(t.location.reload(),Router.navigate("/resources/app/lottery-order.html",{sid:a})),1!==e.status.succeed&&swal({button:"关闭",text:"订单信息提交失败,"+e.status.error_desc,type:"error"})}).catch(function(t){swal({button:"关闭",text:"订单信息提交失败，请检查网络"})}))}).catch(swal.noop)})}else swal({button:"注册",text:n.msg}).then(function(t){t&&Router.navigate("/resources/app/shopzc.html")});function w(t){var e={price:t.price,sid:a};api("get_ticket",e).then(function(e){if(f===t.price)if(e=JSON.parse(e),$(".load-box").addClass("loaded"),1===e.status.succeed){var n=e.data;if(p.html(""),n.length)for(var i=0;i<n.length;i++)x[n[i].id]||(x[n[i].id]={num:0,name:n[i].title}),g(n[i],p);else"0"===t.price?p.append('<div class="no-lottery"><p>暂无热销票种</p></div>'):p.append('<div class="no-lottery"><p>您所注册的区域没有当前所选票种</p></div>'),$(".load-box").addClass("loaded")}else swal({button:"关闭",text:"获取公益票列表失败，"+e.status.error_desc,type:"error"}),$(".load-box").addClass("loaded")}).catch(function(t){$(".load-box").addClass("loaded"),swal({button:"关闭",text:"获取数据失败，请检查网络！"})})}function g(t,e){var n=t;e.append('\n          <div class="item-box lottery_item d-flex justify-content-between align-items-center">\n            <div class="item-info lottery_info">\n              <div class="item-title mb-3 lottery_title">'+n.title+'</div>\n              <div class="item-award mb-3 lottery_award">'+n.description+'</div>\n              <div class="item-price mb-3 lottery_price">￥'+n.price+'</div>\n            </div>\n            <div class="item-number with-inventory text-center">\n              <div class="number-container">\n                <span class="f-20 mr-3 minus"><i class="fa fa-minus-circle minus_btn" aria-hidden="true"></i></span>\n                <span class="f-20 mr-3 loterry_number">'+x[n.id].num+'</span>\n                <span class="text-red plus f-20"><i class="fa fa-plus-circle plus_btn" aria-hidden="true"></i></span>\n              </div>\n              <div class="inventory opacity mb-3">\n                <div class="item-award" style="width:60px;height:17px">'+(n.inventory>99?"":"库存"+n.inventory)+'</div>\n              </div>\n            </div>\n            <div class="sold-out hidden"></div>\n          </div>\n          ');var i=$(".lottery_item:last");i.data("item_data",n),n.inventory<=0?(i.find(".sold-out").removeClass("hidden"),i.find(".item-number").addClass("hidden")):x[t.id].num>0?(i.find(".item-number .minus").removeClass("hidden"),i.find(".item-number .loterry_number").removeClass("hidden"),i.find(".item-number .inventory").removeClass("opacity")):(i.find(".item-number .minus").addClass("hidden"),i.find(".item-number .loterry_number").addClass("hidden"),i.find(".item-number .inventory").addClass("opacity"))}}),t.sid=a,t.active_menu="apply"}(window));