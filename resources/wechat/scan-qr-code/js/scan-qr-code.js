"use strict";$(function(e){var s,a,t=(s=new RegExp("(^|&)"+"sid"+"=([^&]*)(&|$)"),null!=(a=e.location.search.substr(1).match(s))?unescape(a[2]):null),n=$(".js-load-box"),o=$(".load-text");function d(s){var a=s.appid,t=s.ticket,n=parseInt((new Date).valueOf()/1e3),o=function(e){for(var s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",a=[],t=0;t<e;t++){var n=s.substr(parseInt(Math.random()*s.length),1);a.push(n)}return a.join("")}(16),d="jsapi_ticket="+t+"&noncestr="+o+"&timestamp="+n+"&url="+e.location.href.split("#")[0],i=$.sha1(d);wx.config({debug:!1,appId:a,timestamp:n,nonceStr:o,signature:i,jsApiList:["scanQRCode"]})}n&&(n.addClass("loading"),$(".load-box").removeClass("loaded"),o.text("正在加载...")),apiByObj({service:"getTicket",path:"/mobile/Js_interface/"}).then(function(e){e&&d(e=JSON.parse(e))}).catch(function(e){n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"})}),wx.error(function(e){if(e){JSON.stringify(e);"config:invalid signature"===e.errMsg&&apiByObj({service:"getNewTicket",path:"/mobile/Js_interface/"}).then(function(e){e&&d(e=JSON.parse(e))}).catch(function(e){n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"})}),"config:invalid url domain"===e.errMsg&&(n.removeClass("loading"),$(".load-box").addClass("loaded"),swal({button:"关闭",text:"扫码功能加载失败请再次加载"}))}}),wx.ready(function(){n&&(n.removeClass("loading"),$(".load-box").addClass("loaded")),$(".redeem-prize").click(function(){wx.scanQRCode({desc:"scanQRCode desc",needResult:1,scanType:["qrCode","barCode","PDF417"],success:function(e){var s={code:e.resultStr.split(",")[1],sid:t};$(".load-box").removeClass("loaded"),$(".js-load-box").addClass("loading"),$(".load-text").text("正在查询..."),apiByObj({service:"doRedeem",path:"/mobile/Redeem/",data:s}).then(function(e){!function(e){var s=e.data?JSON.parse(e.data):null,a=s?s.content:null,n=e.msg,o="";s&&"1301"==s.ret?a&&a.prize&&(o+='<div class="py-10 f-20">兑奖成功，奖金 '+a.prize+"元</div>"):s&&s.msg&&(o+='<div class="py-10 f-20">'+s.msg+"</div>");a&&a.gameName&&(o+='<div class=\'pt-10 text-left\'><span class="s-l">兑换票种：</span><span class="s-r">'+a.gameName+"</span></div>");if(a&&a.transacId){var d=a.transacId.substr(0,14);i=d,l=(i=String(i)).substring(0,4),r=i.substring(4,6),c=i.substring(6,8),u=i.substring(8,10),p=i.substring(10,12),g=i.substring(12,14),o+='<div class=\'pt-10 text-left\'><span class="s-l">扫码时间：</span><span class="s-r">'+(d=l+"-"+r+"-"+c+" "+u+":"+p+":"+g)+"</span></div>"}var i,l,r,c,u,p,g;a&&a.ticketNo&&(o+=' <div class=\'pt-10 text-left\'><span class="s-l">兑奖单号：</span><span class="s-r">'+a.ticketNo+"</sapn></div>");var v="<div>"+o+"</div>";o&&($(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading"),s&&"1301"==s.ret?swal({content:$(v).get(0),type:"info",buttons:["关闭","确定"]}).then(function(e){e&&Router.navigate("/resources/wechat/scan-qr-code/redeem-record.html",{sid:t})}):swal({content:$(v).get(0),type:"info",button:"关闭"}));if(n){var f='<div class="py-10 f-20">'+n+"</div>";$(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading"),swal({content:$(f).get(0),type:"error",button:"关闭"})}}(e=JSON.parse(e))}).catch(function(e){$(".load-box").addClass("loaded"),$(".js-load-box").removeClass("loading");e=JSON.stringify(e);swal({button:"关闭",text:"网络连接错误，请重试"})})},error:function(e){e.errMsg.indexOf("function_not_exist")>0&&swal({button:"关闭",text:"版本过低请升级"})}})})}),$(".redeem-record").click(function(){Router.navigate("/resources/wechat/scan-qr-code/redeem-record.html",{sid:t})})}(window));